<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sn√∏ballkrig: 10 ‚Üí 6 sitteplasser</title>
  <style>
    html, body { height:100%; margin:0; background:#0b1020; }
    .wrap { height:100%; display:flex; align-items:center; justify-content:center; }
    canvas { background: linear-gradient(#bfe7ff, #f3fbff); border-radius: 14px; box-shadow: 0 12px 40px rgba(0,0,0,.35); }
    .hud {
      position: fixed; left: 12px; top: 12px; right: 12px;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      pointer-events:none;
    }
    .pill { background: rgba(0,0,0,.35); padding: 6px 10px; border-radius: 999px; }
    .hint {
      position: fixed; left: 12px; bottom: 12px; right: 12px;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,.88);
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="c" width="980" height="620"></canvas>
  </div>

  <div class="hud" id="hud"></div>

  <div class="hint">
    <div class="pill">Start: Enter ‚Ä¢ Restart: R</div>
    <div class="pill">Bevegelse: WASD / Piler / IJKL / TFGH</div>
    <div class="pill">Kast: F / / / O / Y</div>
    <div class="pill">(Resten er bots ‚Äì kan skrus av/p√• i koden)</div>
  </div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const hudEl = document.getElementById("hud");

  // ----------------------------
  // Spilloppsett (tweak her)
  // ----------------------------
  const TOTAL_PLAYERS = 10;
  const CHAIRS = 6;

  const FIGHT_SECONDS = 22;      // sn√∏ballfase
  const SCRAMBLE_SECONDS = 10;   // stol-scramble
  const FREEZE_SECONDS = 1.8;    // hvor lenge man er "frossen" n√•r man treffes

  const PLAYER_R = 14;
  const PLAYER_SPEED = 2.35;
  const BOT_SPEED = 2.15;

  const BALL_R = 5;
  const BALL_SPEED = 6.4;
  const BALL_LIFE = 80; // frames

  // Hvor mange menneskespillere p√• samme tastatur (0‚Äì4 i dette oppsettet)
  // (Du kan sette til 0 for full bot-kaos, eller 4 for mer menneskelig action.)
  const HUMAN_SLOTS = 4;

  // Tastaturmapping for opptil 4 mennesker (resten blir bots)
  const keysets = [
    // P1: WASD + F
    { up:"KeyW", down:"KeyS", left:"KeyA", right:"KeyD", shoot:"KeyF" },
    // P2: Piler + /
    { up:"ArrowUp", down:"ArrowDown", left:"ArrowLeft", right:"ArrowRight", shoot:"Slash" },
    // P3: IJKL + O
    { up:"KeyI", down:"KeyK", left:"KeyJ", right:"KeyL", shoot:"KeyO" },
    // P4: TFGH + Y
    { up:"KeyT", down:"KeyG", left:"KeyF", right:"KeyH", shoot:"KeyY" },
  ];

  // ----------------------------
  // Verkt√∏y
  // ----------------------------
  const keys = new Set();
  addEventListener("keydown", (e) => {
    if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space"].includes(e.code)) e.preventDefault();
    keys.add(e.code);

    if (e.code === "Enter") start();
    if (e.code === "KeyR") reset();
  }, { passive:false });

  addEventListener("keyup", (e) => keys.delete(e.code));

  function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
  function dist2(ax, ay, bx, by) { const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }
  function rand(min, max) { return Math.random()*(max-min)+min; }
  function pick(arr){ return arr[(Math.random()*arr.length)|0]; }

  function niceColor(i){
    const base = [
      "#ff5c5c","#ffb84d","#ffd84d","#9dff6a","#5dffcc",
      "#5cc8ff","#7b86ff","#c86bff","#ff63c2","#ffffff"
    ];
    return base[i % base.length];
  }

  // ----------------------------
  // Banen
  // ----------------------------
  const W = canvas.width, H = canvas.height;
  const arena = { x: 20, y: 20, w: W-40, h: H-40 };

  // Stoler: faste posisjoner i en "kontorsone"
  const chairs = [];
  function buildChairs(){
    chairs.length = 0;
    const zone = { x: W*0.58, y: H*0.20, w: W*0.34, h: H*0.60 };
    for (let i=0;i<CHAIRS;i++){
      const col = i % 2;
      const row = (i/2)|0;
      chairs.push({
        x: zone.x + zone.w*(0.28 + 0.44*col),
        y: zone.y + zone.h*(0.18 + 0.21*row),
        r: 18,
        claimedBy: null
      });
    }
  }

  // ----------------------------
  // Spillobjekter
  // ----------------------------
  const players = [];
  const balls = [];

  function spawnPlayers(){
    players.length = 0;
    for (let i=0;i<TOTAL_PLAYERS;i++){
      const isHuman = i < HUMAN_SLOTS;
      players.push({
        id: i+1,
        name: `P${i+1}`,
        x: rand(arena.x+40, arena.x+arena.w-40),
        y: rand(arena.y+40, arena.y+arena.h-40),
        vx: 0, vy: 0,
        r: PLAYER_R,
        color: niceColor(i),
        human: isHuman,
        frozenUntil: 0,
        seated: false,
        seatIndex: -1,
        cooldown: 0,
        aimX: 1, aimY: 0, // siste bevegelsesretning
      });
    }
  }

  function reset(){
    frame = 0;
    phase = "lobby"; // lobby ‚Üí fight ‚Üí scramble ‚Üí results
    phaseUntil = 0;
    balls.length = 0;
    buildChairs();
    spawnPlayers();
    winners.length = 0;
    message = "Trykk Enter for √• starte";
  }

  function start(){
    if (phase !== "lobby" && phase !== "results") return;
    balls.length = 0;
    for (const c of chairs) c.claimedBy = null;
    for (const p of players){
      p.seated = false; p.seatIndex = -1;
      p.frozenUntil = 0; p.cooldown = 0;
      p.x = rand(arena.x+40, arena.x+arena.w-40);
      p.y = rand(arena.y+40, arena.y+arena.h-40);
    }
    winners.length = 0;

    phase = "fight";
    phaseUntil = frame + Math.floor(FIGHT_SECONDS*60);
    message = "SN√òBALLKRIG! Frys folk f√∏r stolene √•pner‚Ä¶";
  }

  function dieIntoResults(){
    phase = "results";
    message = "Runde ferdig! Enter for ny runde ‚Ä¢ R for reset";
  }

  function shoot(p){
    if (p.cooldown > 0 || p.seated) return;
    const ax = p.aimX, ay = p.aimY;
    const len = Math.hypot(ax, ay) || 1;
    const ux = ax/len, uy = ay/len;
    balls.push({
      x: p.x + ux*(p.r+6),
      y: p.y + uy*(p.r+6),
      vx: ux*BALL_SPEED,
      vy: uy*BALL_SPEED,
      life: BALL_LIFE,
      owner: p.id
    });
    p.cooldown = 18;
  }

  // Enkle bots: i fight-fase jager de n√¶rmeste, skyter n√•r de kan.
  // I scramble-fase l√∏per de mot n√¶rmeste ledige stol.
  function botStep(p){
    if (p.seated) return;

    let tx = p.x, ty = p.y;

    if (phase === "fight"){
      // velg m√•l: n√¶rmeste ikke-seated
      let best = null, bestD = 1e18;
      for (const q of players){
        if (q.id === p.id || q.seated) continue;
        const d = dist2(p.x,p.y,q.x,q.y);
        if (d < bestD) { bestD = d; best = q; }
      }
      if (best){
        tx = best.x; ty = best.y;
        // skyt hvis "i samme region"
        if (bestD < 220*220 && p.cooldown<=0 && p.frozenUntil<=frame){
          p.aimX = best.x - p.x; p.aimY = best.y - p.y;
          shoot(p);
        }
      }
    } else if (phase === "scramble"){
      let best = null, bestD = 1e18;
      for (let i=0;i<chairs.length;i++){
        const c = chairs[i];
        if (c.claimedBy != null) continue;
        const d = dist2(p.x,p.y,c.x,c.y);
        if (d < bestD) { bestD = d; best = c; }
      }
      if (best){ tx = best.x; ty = best.y; }
    }

    const dx = tx - p.x, dy = ty - p.y;
    const len = Math.hypot(dx, dy) || 1;

    // litt "wiggle" for kaos
    const wig = (phase === "fight") ? 0.35 : 0.15;
    const nx = (dx/len) + rand(-wig, wig);
    const ny = (dy/len) + rand(-wig, wig);

    const s = (phase === "scramble") ? BOT_SPEED*1.12 : BOT_SPEED;
    p.vx = nx * s;
    p.vy = ny * s;
    p.aimX = p.vx; p.aimY = p.vy;
  }

  function humanStep(p, slot){
    if (p.seated) return;
    const k = keysets[slot];
    let mx = 0, my = 0;

    if (keys.has(k.left)) mx -= 1;
    if (keys.has(k.right)) mx += 1;
    if (keys.has(k.up)) my -= 1;
    if (keys.has(k.down)) my += 1;

    const len = Math.hypot(mx, my) || 1;
    const ux = mx/len, uy = my/len;

    const s = (phase === "scramble") ? PLAYER_SPEED*1.12 : PLAYER_SPEED;
    p.vx = ux * s;
    p.vy = uy * s;

    if (mx !== 0 || my !== 0){ p.aimX = mx; p.aimY = my; }

    if (keys.has(k.shoot) && phase === "fight" && p.frozenUntil <= frame){
      shoot(p);
    }
  }

  // ----------------------------
  // Spill-loop
  // ----------------------------
  let frame = 0;
  let phase = "lobby";
  let phaseUntil = 0;
  let message = "";
  const winners = [];

  function update(){
    frame++;

    // faseoverganger
    if (phase === "fight" && frame >= phaseUntil){
      phase = "scramble";
      phaseUntil = frame + Math.floor(SCRAMBLE_SECONDS*60);
      message = "STOLENE √ÖPNER! F√∏rstemann til 6 plasser vinner!";
      // nullstill stoler
      for (const c of chairs) c.claimedBy = null;
    }
    if (phase === "scramble" && (frame >= phaseUntil || winners.length >= CHAIRS)){
      // fylle winners dersom noen ikke rakk: de som faktisk satt
      winners.length = 0;
      for (let i=0;i<chairs.length;i++){
        const c = chairs[i];
        if (c.claimedBy != null) winners.push(c.claimedBy);
      }
      dieIntoResults();
    }

    // input + bots
    for (let i=0;i<players.length;i++){
      const p = players[i];
      if (p.cooldown > 0) p.cooldown--;

      // frossen? st√•r stille
      if (p.frozenUntil > frame){ p.vx = 0; p.vy = 0; continue; }

      if (p.human){
        humanStep(p, i); // bruker samme indeks som slot for enkelhet
      } else {
        botStep(p);
      }
    }

    // bevegelser
    for (const p of players){
      if (p.seated) continue;

      p.x += p.vx;
      p.y += p.vy;

      // vegger
      p.x = clamp(p.x, arena.x + p.r, arena.x + arena.w - p.r);
      p.y = clamp(p.y, arena.y + p.r, arena.y + arena.h - p.r);
    }

    // sn√∏baller
    for (let i=balls.length-1;i>=0;i--){
      const b = balls[i];
      b.x += b.vx;
      b.y += b.vy;
      b.life--;

      // utenfor / d√∏d
      if (b.life <= 0 || b.x < arena.x-40 || b.x > arena.x+arena.w+40 || b.y < arena.y-40 || b.y > arena.y+arena.h+40){
        balls.splice(i,1);
        continue;
      }

      // treff spillere
      if (phase === "fight"){
        for (const p of players){
          if (p.id === b.owner || p.seated) continue;
          if (p.frozenUntil > frame) continue;

          const rr = (p.r + BALL_R);
          if (dist2(p.x,p.y,b.x,b.y) <= rr*rr){
            // frys
            p.frozenUntil = frame + Math.floor(FREEZE_SECONDS*60);
            balls.splice(i,1);
            break;
          }
        }
      }
    }

    // scramble: kravle til stol og "sette seg"
    if (phase === "scramble"){
      for (let ci=0;ci<chairs.length;ci++){
        const c = chairs[ci];
        if (c.claimedBy != null) continue;

        for (const p of players){
          if (p.seated) continue;
          const rr = (p.r + c.r);
          if (dist2(p.x,p.y,c.x,c.y) <= rr*rr){
            // claim
            c.claimedBy = p.id;
            p.seated = true;
            p.seatIndex = ci;
            p.vx = 0; p.vy = 0;
            winners.push(p.id);
            break;
          }
        }
      }
    }
  }

  // ----------------------------
  // Tegning
  // ----------------------------
  function draw(){
    ctx.clearRect(0,0,W,H);

    // arena
    ctx.fillStyle = "rgba(255,255,255,.65)";
    roundRect(ctx, arena.x, arena.y, arena.w, arena.h, 18, true, false);

    // kontorsone (stoler)
    ctx.fillStyle = "rgba(30,40,70,.10)";
    roundRect(ctx, W*0.56, H*0.16, W*0.38, H*0.68, 18, true, false);

    // stoler
    for (let i=0;i<chairs.length;i++){
      const c = chairs[i];
      const active = (phase === "scramble" || phase === "results");
      const claimed = c.claimedBy != null;

      ctx.beginPath();
      ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);

      if (!active){
        ctx.fillStyle = "rgba(0,0,0,.15)";
        ctx.fill();
      } else if (!claimed){
        ctx.fillStyle = "rgba(30,160,90,.18)";
        ctx.fill();
        ctx.lineWidth = 3;
        ctx.strokeStyle = "rgba(30,160,90,.45)";
        ctx.stroke();
      } else {
        const pid = c.claimedBy;
        const p = players[pid-1];
        ctx.fillStyle = "rgba(0,0,0,.18)";
        ctx.fill();
        ctx.lineWidth = 3;
        ctx.strokeStyle = p ? p.color : "rgba(255,255,255,.6)";
        ctx.stroke();
      }
    }

    // sn√∏baller
    for (const b of balls){
      ctx.beginPath();
      ctx.arc(b.x, b.y, BALL_R, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(0,0,0,.18)";
      ctx.stroke();
    }

    // spillere
    for (const p of players){
      // skygge
      ctx.beginPath();
      ctx.arc(p.x+3, p.y+5, p.r*0.95, 0, Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,.12)";
      ctx.fill();

      // kropp
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);

      const frozen = p.frozenUntil > frame;
      ctx.fillStyle = frozen ? "rgba(230,245,255,.92)" : p.color;
      ctx.fill();

      ctx.lineWidth = 3;
      ctx.strokeStyle = "rgba(0,0,0,.18)";
      ctx.stroke();

      // ‚Äúansikt/retning‚Äù
      const len = Math.hypot(p.aimX, p.aimY) || 1;
      const ux = p.aimX/len, uy = p.aimY/len;
      ctx.beginPath();
      ctx.arc(p.x + ux*(p.r*0.45), p.y + uy*(p.r*0.45), 3.5, 0, Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.fill();

      // navn
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.fillStyle = "rgba(0,0,0,.45)";
      ctx.fillText(p.name, p.x, p.y - p.r - 10);

      // frossen-ikon
      if (frozen){
        ctx.font = "14px system-ui";
        ctx.fillStyle = "rgba(70,120,170,.85)";
        ctx.fillText("‚ùÑ", p.x, p.y + 5);
      }

      // ‚Äúsitter‚Äù
      if (p.seated){
        ctx.font = "14px system-ui";
        ctx.fillStyle = "rgba(0,0,0,.45)";
        ctx.fillText("ü™ë", p.x, p.y + p.r + 18);
      }
    }

    // topptekst/melding
    ctx.textAlign = "center";
    ctx.font = "22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(0,0,0,.55)";
    ctx.fillText("Sn√∏ballkrig: 10 kolleger ‚Üí 6 sitteplasser", W/2, 42);

    ctx.font = "16px system-ui";
    ctx.fillStyle = "rgba(0,0,0,.55)";
    ctx.fillText(message, W/2, 70);

    if (phase === "results"){
      const seated = chairs
        .map((c, idx) => ({ idx, pid: c.claimedBy }))
        .filter(x => x.pid != null);

      ctx.font = "18px system-ui";
      ctx.fillStyle = "rgba(0,0,0,.62)";
      ctx.fillText(`Vinnere (de som fikk plass): ${seated.length}/${CHAIRS}`, W/2, H-84);

      ctx.font = "14px system-ui";
      ctx.fillStyle = "rgba(0,0,0,.55)";
      const names = seated.map(s => `P${s.pid}`).join("  ‚Ä¢  ");
      ctx.fillText(names || "Ingen rakk √• sette seg üòÖ", W/2, H-58);
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function renderHud(){
    const timeLeft = (phase === "fight" || phase === "scramble")
      ? Math.max(0, Math.ceil((phaseUntil - frame)/60))
      : 0;

    const phaseLabel = phase === "lobby" ? "Lobby"
      : phase === "fight" ? "Sn√∏ballfase"
      : phase === "scramble" ? "Stol-scramble"
      : "Resultat";

    const frozenCount = players.filter(p => p.frozenUntil > frame).length;
    const seatedCount = chairs.filter(c => c.claimedBy != null).length;

    hudEl.innerHTML = `
      <div class="pill"><b>Fase:</b> ${phaseLabel}</div>
      <div class="pill"><b>Tid:</b> ${timeLeft}s</div>
      <div class="pill"><b>Frosne:</b> ${frozenCount}</div>
      <div class="pill"><b>Sitteplasser tatt:</b> ${seatedCount}/${CHAIRS}</div>
    `;
  }

  function loop(){
    if (phase !== "lobby" && phase !== "results") update();
    draw();
    renderHud();
    requestAnimationFrame(loop);
  }

  // init
  reset();
  loop();
})();
</script>
</body>
</html>
